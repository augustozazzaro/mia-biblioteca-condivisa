<script type="module">
// NOTA: Abbiamo cambiato <script> in <script type="module"> per usare 'import'
// ----------------------------------------------------------------------------------
// PASSO 1: LIBRERIE FIREBASE E CONFIGURAZIONE (INTEGRATE)
// ----------------------------------------------------------------------------------

// Import necessari per l'App e per Firestore (il database)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";


// CONFIGURAZIONE PERSONALE PRESA DALLA CONSOLE
const firebaseConfig = {
    apiKey: "AIzaSyCOD5J_2s4AOXFWpgq4_O5PLox-Kb0xDXQ",
    authDomain: "biblioteca-sarno-e-zazzaro.firebaseapp.com",
    projectId: "biblioteca-sarno-e-zazzaro",
    // VALORE ORIGINALE FORNITO DALLA TUA CONSOLE:
    storageBucket: "biblioteca-sarno-e-zazzaro.firebasestorage.app", 
    messagingSenderId: "47424170960",
    appId: "1:47424170960:web:f88feb1c208383682467d5",
    measurementId: "G-GDLWFWX9JP" 
};


// Inizializzazione di Firebase e Firestore
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const libraryCollection = collection(db, "libri"); // Collezione chiamata 'libri'

// ----------------------------------------------------------------------------------
// DATI LOCALI E COSTANTI
// ----------------------------------------------------------------------------------
let library = [];Â 
let currentBookIdToEdit = null;Â 
let nextId = 1;

const LOCATIONS = ["INGRESSO", "CAMERA ENRICO", "CAMERA AUGUSTO", "CAMERA EMMA E ALBERTO", "SALOTTO", "CUCINA", "UNIVERSITÃ€", "POLLA"];
const GENRES = ["Romanzo", "Saggio", "Fantasy", "Thriller", "Giallo", "Storico", "Biografia", "Poesia", "Fantascienza", "Horror", "Bambini", "Graphic Novel", "Filosofia", "Economia", "Finanza", "Scienza", "Arte", "Altro"];


// --- FUNZIONI DI DATABASE ASINCRONE ---

async function loadLibrary() {
Â  Â  console.log("Tentativo di caricamento dati dal cloud...");
Â  Â  library = [];
Â  Â  try {
Â  Â  Â  Â  const querySnapshot = await getDocs(libraryCollection);
Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  library.push({ ...doc.data(), uniqueId: doc.id });Â 
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  library.sort((a, b) => a.title.localeCompare(b.title));

Â  Â  Â  Â  document.getElementById('searchQuery').value = '';Â 
Â  Â  Â  Â  dynamicSearch();Â 
Â  Â  Â  Â  console.log(`Caricamento completato. Trovati ${library.length} libri.`);
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Errore durante il caricamento da Firestore: ", e);
Â  Â  Â  Â  alert("âŒ Errore! Connessione fallita. Controlla le credenziali Firebase e le regole di sicurezza.");
Â  Â  Â  Â  document.getElementById('book-list-container').innerHTML = '<p style="text-align:center; color:#666; padding: 20px;">Non Ã¨ stato possibile caricare i dati. Database offline?</p>';
Â  Â  }
}


async function addBook() {
Â  const author = document.getElementById('author').value.trim();
Â  const title = document.getElementById('title').value.trim();
Â  const yearStr = document.getElementById('year').value.trim();
Â  const pagesStr = document.getElementById('pages').value.trim();
Â  const genre = document.getElementById('genre').value;
Â  const location = document.getElementById('location').value;
Â  const notes = document.getElementById('notes').value.trim();

Â  if (!author || !title || !yearStr || !genre || genre === '' || !location) {
Â  Â  alert('âš ï¸ Attenzione! Compila tutti i campi obbligatori.');
Â  Â  return;
Â  }
Â  if (!/^[a-zA-Z\sÃ Ã¨Ã©Ã¬Ã²Ã¹Ã¡Ã©Ã­Ã³ÃºÃ§Ã±']+$/.test(author)) {
Â  Â  alert('âŒ Errore! Il campo Autore deve contenere solo lettere.');
Â  Â  return;
Â  }
Â  const year = parseInt(yearStr);
Â  const pages = pagesStr ? parseInt(pagesStr) : 0;
Â  const currentYear = new Date().getFullYear();
Â  if (isNaN(year) || yearStr.length > 4 || year < 0 || year > currentYear) {
Â  Â  alert(`âŒ Errore! Anno di pubblicazione non valido.`);
Â  Â  return;
Â  }
Â  if (isNaN(pages) || pages < 0) {
Â  Â  alert(`âŒ Errore! Numero di pagine non valido.`);
Â  Â  return;
Â  }
Â Â 
Â  const newBookData = {Â 
Â  Â  author: capitalizeWords(author),Â 
Â  Â  title: capitalizeWords(title),Â 
Â  Â  year: year,Â 
Â  Â  pages: pages,
Â  Â  genre: capitalizeWords(genre),Â 
Â  Â  location: location,
Â  Â  notes: notesÂ 
Â  };
Â Â 
Â  try {
Â  Â  Â  await addDoc(libraryCollection, newBookData);
Â  Â  Â  alert(`â• Libro Aggiunto! "${newBookData.title}" Ã¨ ora condiviso nel Cloud.`);
Â  Â  Â  hideAllPanels();
Â  Â  Â  loadLibrary();Â 
Â  } catch (e) {
Â  Â  Â  console.error("Errore durante l'aggiunta a Firestore: ", e);
Â  Â  Â  alert("âŒ Errore! Non Ã¨ stato possibile aggiungere il libro al database.");
Â  }
}


async function saveEditedBook() {
Â  Â  const uniqueId = currentBookIdToEdit;
Â  Â  if (uniqueId === null) {
Â  Â  Â  Â  alert('Errore: Nessun libro selezionato per la modifica.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const author = document.getElementById('edit-author').value.trim();
Â  Â  const title = document.getElementById('edit-title').value.trim();
Â  Â  const yearStr = document.getElementById('edit-year').value.trim();
Â  Â  const pagesStr = document.getElementById('edit-pages').value.trim();
Â  Â  const genre = document.getElementById('edit-genre').value;
Â  Â  const location = document.getElementById('edit-location').value;
Â  Â Â 
Â  Â  if (!author || !title || !yearStr || !genre || genre === '' || !location) {
Â  Â  Â  Â  alert('âš ï¸ Attenzione! Compila tutti i campi obbligatori.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!/^[a-zA-Z\sÃ Ã¨Ã©Ã¬Ã²Ã¹Ã¡Ã©Ã­Ã³ÃºÃ§Ã±']+$/.test(author)) { alert('âŒ Errore! Il campo Autore deve contenere solo lettere.'); return; }
Â  Â  const year = parseInt(yearStr);
Â  Â  const pages = pagesStr ? parseInt(pagesStr) : 0;
Â  Â  const currentYear = new Date().getFullYear();
Â  Â  if (isNaN(year) || yearStr.length > 4 || year < 0 || year > currentYear) { alert(`âŒ Errore! Anno non valido.`); return; }
Â  Â  if (isNaN(pages) || pages < 0) { alert(`âŒ Errore! Numero di pagine non valido.`); return; }
Â  Â Â 
Â  Â  saveNotesFromViewPanel();
Â  Â  const oldBook = library.find(b => b.uniqueId === uniqueId);

Â  Â  const updatedData = {
Â  Â  Â  Â  author: capitalizeWords(author),
Â  Â  Â  Â  title: capitalizeWords(title),
Â  Â  Â  Â  year: year,
Â  Â  Â  Â  pages: pages,
Â  Â  Â  Â  genre: capitalizeWords(genre),
Â  Â  Â  Â  location: location,
Â  Â  Â  Â  notes: oldBook ? oldBook.notes : ''
Â  Â  };
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const bookRef = doc(db, "libri", uniqueId);
Â  Â  Â  Â  await updateDoc(bookRef, updatedData);
Â  Â  Â  Â  alert('âœ… Modifica Riuscita! Il libro Ã¨ stato aggiornato nel Cloud.');
Â  Â  Â  Â  hideAllPanels();
Â  Â  Â  Â  loadLibrary();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Errore durante la modifica su Firestore: ", e);
Â  Â  Â  Â  alert('âŒ Errore critico! Impossibile salvare le modifiche.');
Â  Â  }
}


async function deleteBook(uniqueId) {
Â  Â  try {
Â  Â  Â  Â  await deleteDoc(doc(db, "libri", uniqueId));
Â  Â  Â  Â  alert('ğŸ—‘ï¸ Eliminazione Riuscita! Il libro Ã¨ stato rimosso dal Cloud.');
Â  Â  Â  Â  hideAllPanels();
Â  Â  Â  Â  loadLibrary();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Errore durante l'eliminazione su Firestore: ", e);
Â  Â  Â  Â  alert('âŒ Errore! Non Ã¨ stato possibile eliminare il libro.');
Â  Â  }
}


// --- RESTO DEL CODICE ---

function capitalizeWords(str) {
Â  Â  if (!str) return '';
Â  Â  return str.replace(/\s+/g, ' ').trim().toLowerCase().split(' ').map(word =>Â 
Â  Â  Â  Â  word.charAt(0).toUpperCase() + word.slice(1)
Â  Â  ).join(' ');
}

function saveNotesFromViewPanel() {
Â  Â  if (currentBookIdToEdit !== null) {
Â  Â  Â  Â  const notesArea = document.getElementById('bookNotesArea');
Â  Â  Â  Â  const book = library.find(b => b.uniqueId === currentBookIdToEdit);

Â  Â  Â  Â  if (book && notesArea) {
Â  Â  Â  Â  Â  Â  if (book.notes !== notesArea.value) {
Â  Â  Â  Â  Â  Â  Â  Â  book.notes = notesArea.value.trim();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}

function populateSelects() {
Â  Â  const locSelects = document.querySelectorAll('#location, #edit-location');
Â  Â  locSelects.forEach(select => {
Â  Â  Â  Â  select.innerHTML = '';
Â  Â  Â  Â  LOCATIONS.forEach(loc => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.textContent = loc;
Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  });

Â  Â  const genSelects = document.querySelectorAll('#genre, #edit-genre');
Â  Â  genSelects.forEach(select => {
Â  Â  Â  Â  select.innerHTML = '';
Â  Â  Â  Â  const defaultOpt = document.createElement('option');
Â  Â  Â  Â  defaultOpt.textContent = "Seleziona Genere";
Â  Â  Â  Â  defaultOpt.value = "";
Â  Â  Â  Â  select.appendChild(defaultOpt);
Â  Â  Â  Â Â 
Â  Â  Â  Â  GENRES.forEach(gen => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.textContent = gen;
Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  });
}


function hideAllPanels() {
Â  Â  saveNotesFromViewPanel();
Â  Â Â 
Â  Â  document.getElementById('addPanel').style.display = 'none';
Â  Â  document.getElementById('editPanel').style.display = 'none';
Â  Â  document.getElementById('viewPanel').style.display = 'none';
Â  Â  currentBookIdToEdit = null;
Â  Â  dynamicSearch();
}

function showAddPanel() {
Â  Â  hideAllPanels();
Â  Â  document.getElementById('addPanel').style.display = 'block';
Â  Â Â 
Â  Â  document.getElementById('author').value = '';
Â  Â  document.getElementById('title').value = '';
Â  Â  document.getElementById('year').value = '';
Â  Â  document.getElementById('pages').value = '';
Â  Â  document.getElementById('genre').value = '';Â 
Â  Â  document.getElementById('location').value = 'INGRESSO';
Â  Â  document.getElementById('notes').value = '';
}


function viewBookDetails(uniqueId) {
Â  Â  saveNotesFromViewPanel();Â 
Â  Â Â 
Â  Â  hideAllPanels();Â 
Â  Â Â 
Â  Â  const book = library.find(b => b.uniqueId === uniqueId);
Â  Â  if (!book) return;
Â  Â Â 
Â  Â  currentBookIdToEdit = uniqueId;

Â  Â  document.getElementById('viewPanelTitle').textContent = book.title;
Â  Â Â 
Â  Â  const detailsDiv = document.getElementById('singleBookDetails');
Â  Â  const locationBox = document.getElementById('locationBox');
Â  Â Â 
Â  Â  locationBox.innerHTML = `â—† ${book.location}`;

Â  Â  detailsDiv.innerHTML = `
Â  Â  Â  Â  <p><span class="detail-icon">ğŸ‘¤</span> <b>Autore:</b> ${book.author}</p>
Â  Â  Â  Â  <p><span class="detail-icon">ğŸ“–</span> <b>Genere:</b> ${book.genre}</p>
Â  Â  Â  Â  <p><span class="detail-icon">ğŸ“…</span> <b>Anno di Pubblicazione:</b> ${book.year}</p>
Â  Â  Â  Â  <p><span class="detail-icon">ğŸ“„</span> <b>Numero Pagine:</b> ${book.pages > 0 ? book.pages : 'N/D'}</p>
Â  Â  `;
Â  Â Â 
Â  Â  const notesArea = document.getElementById('bookNotesArea');
Â  Â  notesArea.value = book.notes || '';
Â  Â Â 
Â  Â  document.getElementById('viewPanel').style.display = 'block';
}

function confirmDelete(bookTitle) {
Â  Â  const uniqueId = currentBookIdToEdit;
Â  Â  if (uniqueId === null) return;
Â  Â Â 
Â  Â  const confirmation = confirm(`âš ï¸ Sei sicuro di voler ELIMINARE DEFINITIVAMENTE il libro "${bookTitle}"? Questa azione Ã¨ irreversibile.`);
Â  Â  if (confirmation) {
Â  Â  Â  Â  deleteBook(uniqueId);
Â  Â  }
}


function dynamicSearch() {
Â  Â  const q = document.getElementById('searchQuery').value.toLowerCase().trim();
Â  Â  const listContainer = document.getElementById('book-list-container');
Â  Â  listContainer.innerHTML = '';
Â  Â Â 
Â  Â  const filtered = library.filter(b =>Â 
Â  Â  Â  Â  q === '' ||
Â  Â  Â  Â  b.title.toLowerCase().includes(q) ||Â 
Â  Â  Â  Â  b.author.toLowerCase().includes(q) ||
Â  Â  Â  Â  b.genre.toLowerCase().includes(q) ||Â 
Â  Â  Â  Â  b.year.toString().includes(q) || Â  Â Â 
Â  Â  Â  Â  b.location.toLowerCase().includes(q)Â 
Â  Â  ).sort((a, b) => a.title.localeCompare(b.title));

Â  Â  if (filtered.length === 0) {
Â  Â  Â  Â  listContainer.innerHTML = '<p style="text-align:center; color:#666; padding: 20px;">ğŸ¤· Nessun libro trovato. Prova una ricerca diversa o aggiungi un nuovo libro.</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  filtered.forEach(b => {
Â  Â  Â  Â  const pagesInfo = b.pages > 0 ? `${b.pages} pag` : 'N/D';
Â  Â  Â  Â  listContainer.innerHTML += `
Â  Â  Â  Â  Â  Â  <div class='book' onclick="viewBookDetails('${b.uniqueId}')">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="book-title"><span class="list-icon">ğŸ“–</span> ${b.title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="book-author"><span class="list-icon">ğŸ‘¤</span> ${b.author}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="book-meta">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #666; font-size: 0.9em;"><span class="list-icon">ğŸ“…</span> ${b.year} | <span class="list-icon">ğŸ“„</span> ${pagesInfo}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="location-tag">â—† ${b.location}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  });
}


// --- Listener per il salvataggio automatico delle note ---
document.addEventListener('DOMContentLoaded', () => {
Â  Â  const notesArea = document.getElementById('bookNotesArea');
Â  Â  if (notesArea) {
Â  Â  Â  Â  let timeout = null;
Â  Â  Â  Â  notesArea.addEventListener('input', () => {
Â  Â  Â  Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  Â  Â  Â  timeout = setTimeout(saveNotesFromViewPanel, 2000);Â 
Â  Â  Â  Â  });
Â  Â  }
});


// CHIAMATA INIZIALE
loadLibrary();Â 
</script>
